<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Archivos Excel</title>
    <style>
        /* Estilos básicos */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .container {
            width: 80%;
            margin: auto;
            padding: 20px;
        }
        .hidden {
            display: none;
        }
        .toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 2px;
            position: fixed;
            z-index: 1;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
            box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.2);
            transition: opacity 0.6s, visibility 0.6s;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
        }
        .toast.success {
            background-color: #4CAF50;
        }
        .toast.error {
            background-color: #f44336;
        }
        /* Otros estilos */
        #interface1, #interface2 {
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="interface1">
            <h2>Cargar Modelo</h2>
            <input type="file" id="modelFileInput" />
            <button id="uploadModelButton">Cargar Modelo</button>
            <div id="modelFileInfo"></div>
        </div>

        <div id="interface2" class="hidden">
            <h2>Actualizar Archivo</h2>
            <textarea id="textInput" rows="10" cols="50" placeholder="Introduce el texto aquí..."></textarea><br><br>
            <button id="updateButton">Actualizar Archivo</button>
            <button id="downloadButton">Descargar Archivo</button>
            <div id="progressContainer">
                <div id="progressBar" style="width: 0%; height: 20px; background-color: #4CAF50;"></div>
            </div>
        </div>

        <div id="toast" class="toast"></div>
    </div>

    <script>
        const modelFileInput = document.getElementById('modelFileInput');
        const uploadModelButton = document.getElementById('uploadModelButton');
        const modelFileInfo = document.getElementById('modelFileInfo');
        const textInput = document.getElementById('textInput');
        const updateButton = document.getElementById('updateButton');
        const downloadButton = document.getElementById('downloadButton');
        const progressBar = document.getElementById('progressBar');
        const toast = document.getElementById('toast');

        function showToast(message, type) {
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }

        function handleModelUpload(url) {
            if (uploadModelButton.disabled) return;

            uploadModelButton.disabled = true;
            uploadModelButton.textContent = 'Cargando...';

            const formData = new FormData();
            const modelFile = modelFileInput.files[0];
            formData.append('file', modelFile);

            fetch(url, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                showToast(data.message, 'success');
                document.getElementById('interface1').classList.add('hidden');
                document.getElementById('interface2').classList.remove('hidden');
            })
            .catch(error => {
                showToast('Error al subir el modelo: ' + error, 'error');
            })
            .finally(() => {
                uploadModelButton.disabled = false;
                uploadModelButton.textContent = 'Cargar Modelo';
            });
        }

        function handleFormSubmit(url, isUpdate) {
            if (updateButton.disabled) return;

            updateButton.disabled = true;
            updateButton.textContent = isUpdate ? 'Actualizando...' : 'Procesando...';
            progressBar.style.width = '0%';

            const formData = new FormData();
            if (isUpdate) {
                const text = textInput.value;
                formData.append('text', text);
            }

            fetch(url, {
                method: isUpdate ? 'POST' : 'GET',
                body: isUpdate ? formData : null
            })
            .then(response => {
                if (isUpdate) {
                    return response.json();
                } else {
                    return response.blob().then(blob => {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'updated_file.xlsx';
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        showToast('Archivo descargado con éxito!', 'success');
                    });
                }
            })
            .then(data => {
                if (isUpdate && data.file_path) {
                    showToast('Archivo actualizado con éxito!', 'success');
                }
            })
            .catch(error => {
                showToast('Error al procesar el archivo: ' + error, 'error');
            })
            .finally(() => {
                updateButton.disabled = false;
                updateButton.textContent = isUpdate ? 'Actualizar Archivo' : 'Descargar Archivo';
                progressBar.style.width = '0%';
            });
        }

        uploadModelButton.addEventListener('click', () => {
            const url = '/upload_model';
            handleModelUpload(url);
        });

        updateButton.addEventListener('click', () => {
            const url = '/update';
            handleFormSubmit(url, true);
        });

        downloadButton.addEventListener('click', () => {
            const url = '/download';
            handleFormSubmit(url, false);
        });
    </script>
</body>
</html>
